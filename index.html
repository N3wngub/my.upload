<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GitFriendly V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        gh: {
                            bg: '#ffffff', bgDark: '#0d1117',
                            border: '#d0d7de', borderDark: '#30363d',
                            btn: '#2da44e', btnHover: '#2c974b'
                        }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-down': 'slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'fade-out': 'fadeOut 0.2s ease-in forwards',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideDown: { '0%': { transform: 'translateY(0)', opacity: '1' }, '100%': { transform: 'translateY(100%)', opacity: '0' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        fadeOut: { '0%': { opacity: '1' }, '100%': { opacity: '0' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { @apply bg-white dark:bg-[#0d1117] text-[#24292f] dark:text-[#c9d1d9]; }
        .tap-active:active { transform: scale(0.92); transition: transform 0.1s; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .modal-backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden select-none">

    <!-- 1. LOGIN SCREEN -->
    <div id="viewLogin" class="fixed inset-0 z-[100] bg-white dark:bg-[#0d1117] flex flex-col items-center justify-center p-6 animate-fade-in">
        <i class="fab fa-github text-[64px] text-[#24292f] dark:text-white mb-6"></i>
        <h1 class="text-2xl font-bold mb-2">GitFriendly V5</h1>
        <p class="text-gray-500 text-sm text-center mb-8">Login with Personal Access Token</p>
        <div class="w-full max-w-sm space-y-4">
            <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxx" class="w-full bg-gray-50 dark:bg-[#161b22] border border-gray-300 dark:border-[#30363d] rounded-lg px-4 py-3.5 text-sm outline-none focus:border-blue-500 dark:text-white">
            <button onclick="auth.login()" class="w-full bg-[#2da44e] text-white font-bold py-3.5 rounded-lg tap-active shadow-md">Sign in</button>
        </div>
        <a href="https://github.com/settings/tokens/new?scopes=repo&description=GitFriendly" target="_blank" class="mt-8 text-blue-500 text-xs font-bold hover:underline">Get Token <i class="fas fa-external-link-alt"></i></a>
    </div>

    <!-- 2. MAIN APP -->
    <div id="viewApp" class="hidden flex-1 flex flex-col h-full bg-[#f6f8fa] dark:bg-[#010409]">
        
        <!-- Header (Z-Index Increased to 40) -->
        <header class="bg-[#24292f] text-white px-4 py-3 flex items-center justify-between shadow-md shrink-0 z-40 relative">
            <div class="flex items-center gap-3">
                <i class="fab fa-github text-2xl"></i>
                <div><h1 class="font-bold text-sm">GitFriendly</h1><div id="headerUser" class="text-[10px] text-gray-400">@...</div></div>
            </div>
            
            <!-- FIXED LOGOUT BUTTON (Larger & Clearer) -->
            <button onclick="auth.logout()" class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white transition-colors tap-active shadow-sm border border-gray-600">
                <i class="fas fa-sign-out-alt text-sm"></i>
            </button>
        </header>

        <!-- Controls -->
        <div class="bg-white dark:bg-[#0d1117] border-b border-gray-200 dark:border-[#30363d] p-3 space-y-3 z-10 relative">
            <div class="flex gap-2">
                <input type="text" id="repoInput" placeholder="username/repo" class="flex-1 bg-gray-100 dark:bg-[#161b22] rounded-lg px-3 py-2 text-sm outline-none dark:text-white border border-transparent focus:border-blue-500 transition-colors">
                <button onclick="app.loadRepo()" class="bg-gray-100 dark:bg-[#21262d] px-4 rounded-lg text-sm font-bold dark:text-white tap-active border border-gray-200 dark:border-gray-700">Load</button>
            </div>
            <div class="flex items-center justify-between text-xs">
                <div class="flex items-center gap-1 overflow-x-auto hide-scrollbar max-w-[65%]">
                    <button onclick="app.goHome()" class="text-gray-500 dark:text-gray-400 hover:text-blue-500 p-1"><i class="fas fa-home"></i></button>
                    <span class="text-gray-300">/</span>
                    <div id="breadcrumbs" class="font-medium dark:text-white whitespace-nowrap">root</div>
                </div>
                <button onclick="$('branchInputArea').classList.toggle('hidden')" class="flex items-center gap-1 bg-gray-100 dark:bg-[#21262d] px-2.5 py-1.5 rounded-full border border-gray-200 dark:border-[#30363d] text-gray-600 dark:text-gray-300 shadow-sm active:scale-95 transition-transform">
                    <i class="fas fa-code-branch"></i> <span id="branchName">main</span>
                </button>
            </div>
            <div id="branchInputArea" class="hidden flex gap-2 pt-1 animate-fade-in"><input type="text" id="branchInput" placeholder="Branch..." class="flex-1 bg-gray-50 dark:bg-[#161b22] border rounded px-2 py-1 text-xs dark:text-white"><button onclick="app.setBranch()" class="bg-[#2da44e] text-white px-3 py-1 rounded text-xs shadow-sm">Set</button></div>
        </div>

        <!-- File List -->
        <div class="flex-1 overflow-y-auto p-3 pb-24">
            <div id="fileListContainer" class="bg-white dark:bg-[#0d1117] border border-gray-200 dark:border-[#30363d] rounded-xl shadow-sm overflow-hidden min-h-[200px]">
                <div class="bg-gray-50 dark:bg-[#161b22] border-b border-gray-200 dark:border-[#30363d] px-4 py-2 text-xs font-semibold text-gray-500">Files <span id="fileCount" class="float-right font-normal">0 items</span></div>
                <div id="fileList" class="divide-y divide-gray-100 dark:divide-[#30363d]">
                    <div class="p-8 text-center text-gray-400 text-xs">No repository loaded</div>
                </div>
            </div>
        </div>

        <!-- FAB -->
        <button onclick="ui.toggleUploadModal(true)" class="fixed bottom-6 right-6 w-14 h-14 bg-[#2da44e] text-white rounded-full shadow-lg shadow-green-900/30 flex items-center justify-center text-xl tap-active z-30 transition-transform hover:scale-105 active:scale-95"><i class="fas fa-plus"></i></button>
    </div>

    <!-- 3. EDITOR -->
    <div id="viewEditor" class="hidden fixed inset-0 z-50 bg-white dark:bg-[#0d1117] flex flex-col animate-slide-up">
        <div class="h-14 border-b border-gray-200 dark:border-[#30363d] flex items-center justify-between px-4 bg-gray-50 dark:bg-[#161b22]">
            <button onclick="editor.close()" class="text-gray-500 font-medium text-sm px-2">Cancel</button>
            <span id="editorTitle" class="font-mono text-sm font-bold dark:text-white truncate max-w-[150px]">file</span>
            <button onclick="editor.save()" class="bg-[#2da44e] text-white px-3 py-1 rounded text-xs font-bold shadow-sm">Commit</button>
        </div>
        <textarea id="codeEditor" class="flex-1 p-4 font-mono text-sm outline-none bg-white dark:bg-[#0d1117] dark:text-gray-300 resize-none"></textarea>
    </div>

    <!-- 4. UPLOAD MODAL (Smooth) -->
    <div id="uploadModal" class="hidden relative z-[60]" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div id="uploadBackdrop" class="fixed inset-0 modal-backdrop opacity-0" onclick="ui.toggleUploadModal(false)"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto pointer-events-none">
            <div class="flex min-h-full items-end justify-center sm:items-center p-0 sm:p-4">
                <div id="uploadPanel" class="pointer-events-auto relative transform overflow-hidden rounded-t-2xl sm:rounded-2xl bg-white dark:bg-[#161b22] text-left shadow-2xl w-full max-w-md border-t border-gray-200 dark:border-gray-700 translate-y-full opacity-0">
                    <div class="flex items-center justify-between px-4 pt-4 pb-2">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">Add File</h3>
                        <button onclick="ui.toggleUploadModal(false)" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-[#21262d] text-gray-500 dark:text-gray-400 flex items-center justify-center tap-active hover:bg-gray-200 dark:hover:bg-[#30363d]">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="p-6 pt-2">
                        <div class="flex p-1 bg-gray-100 dark:bg-[#0d1117] rounded-lg mb-4 border border-gray-200 dark:border-[#30363d]">
                            <button onclick="ui.setTab('file')" id="tabFile" class="flex-1 py-2 text-xs font-bold rounded bg-white dark:bg-[#21262d] text-gray-900 dark:text-white shadow-sm transition-all">Upload</button>
                            <button onclick="ui.setTab('new')" id="tabNew" class="flex-1 py-2 text-xs font-medium rounded text-gray-500 dark:text-gray-400 transition-all">Create New</button>
                        </div>
                        <div id="paneFile" class="mb-4">
                            <label class="flex flex-col items-center justify-center h-32 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-colors">
                                <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
                                <span class="text-xs text-gray-500">Tap to select file</span>
                                <input type="file" id="fileInput" class="hidden" onchange="if(this.files[0]) $('fileNameDisplay').textContent = this.files[0].name">
                            </label>
                            <div id="fileNameDisplay" class="text-center text-xs font-mono text-blue-600 dark:text-blue-400 mt-2 h-4 truncate"></div>
                        </div>
                        <div id="paneNew" class="hidden mb-4 space-y-3">
                            <input type="text" id="newFileName" placeholder="filename.txt" class="w-full bg-gray-50 dark:bg-[#0d1117] border border-gray-300 dark:border-[#30363d] rounded-lg px-3 py-2 text-sm outline-none dark:text-white">
                            <textarea id="newFileContent" placeholder="Content..." class="w-full h-24 bg-gray-50 dark:bg-[#0d1117] border border-gray-300 dark:border-[#30363d] rounded-lg px-3 py-2 text-xs font-mono outline-none dark:text-white resize-none"></textarea>
                        </div>
                        <input type="text" id="commitMsg" placeholder="Commit message (optional)" class="w-full bg-white dark:bg-[#0d1117] border border-gray-300 dark:border-[#30363d] rounded-lg px-3 py-2 text-sm outline-none dark:text-white mb-4">
                        <div class="flex gap-3">
                            <button onclick="ui.toggleUploadModal(false)" class="flex-1 bg-gray-100 dark:bg-[#21262d] text-gray-700 dark:text-gray-300 font-bold py-3 rounded-lg tap-active hover:bg-gray-200 dark:hover:bg-[#30363d]">Cancel</button>
                            <button onclick="app.performAction()" class="flex-1 bg-[#2da44e] text-white font-bold py-3 rounded-lg tap-active shadow-sm hover:bg-[#2c974b]">Commit</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- UTILS -->
    <div id="loader" class="hidden fixed inset-0 z-[70] bg-white/60 dark:bg-black/60 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white dark:bg-[#161b22] p-4 rounded-2xl shadow-xl flex flex-col items-center"><div class="w-8 h-8 border-4 border-[#2da44e]/30 border-t-[#2da44e] rounded-full animate-spin"></div></div>
    </div>
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full shadow-lg z-[80] opacity-0 pointer-events-none transition-all bg-[#24292f] text-white text-xs font-medium flex gap-2 items-center"><i id="toastIcon" class="fas fa-check"></i><span id="toastMsg">Msg</span></div>

    <script>
        const $ = id => document.getElementById(id);
        const store = { token: localStorage.getItem('gfv5_token'), repo: localStorage.getItem('gfv5_repo'), user: null, path: '', files: [], branch: 'main' };

        // --- AUTH ---
        const auth = {
            async login() {
                const t = $('tokenInput').value.trim();
                if(!t) return ui.toast('Token Required', 'err');
                ui.load(1);
                try {
                    const r = await fetch('https://api.github.com/user', { headers: { Authorization: `token ${t}` } });
                    if(!r.ok) throw new Error('Invalid Token');
                    store.user = await r.json(); store.token = t; localStorage.setItem('gfv5_token', t);
                    $('viewLogin').classList.add('hidden'); $('viewApp').classList.remove('hidden'); $('headerUser').textContent = '@' + store.user.login;
                    if(store.repo) { $('repoInput').value = store.repo; app.loadRepo(); }
                } catch(e) { ui.toast(e.message, 'err'); } finally { ui.load(0); }
            },
            logout() { 
                if(confirm('ยืนยันการออกจากระบบ?')) {
                    localStorage.removeItem('gfv5_token'); 
                    localStorage.removeItem('gfv5_repo');
                    location.reload(); 
                }
            },
            init() { if(store.token) { $('tokenInput').value = store.token; this.login(); } }
        };

        // --- APP LOGIC ---
        const app = {
            async loadRepo() {
                let n = $('repoInput').value.trim();
                if(!n) return ui.toast('Enter Repo', 'err');
                if(!n.includes('/')) n = `${store.user.login}/${n}`;
                store.repo = n; localStorage.setItem('gfv5_repo', n); store.path = ''; await this.fetch();
            },
            async fetch() {
                ui.load(1);
                try {
                    const r = await fetch(`https://api.github.com/repos/${store.repo}/contents/${store.path}?ref=${store.branch}`, { headers: { Authorization: `token ${store.token}` } });
                    if(r.status===404 && !store.path) return ui.renderEmpty();
                    if(!r.ok) throw new Error('Load Failed');
                    const d = await r.json(); store.files = Array.isArray(d) ? d : [d];
                    ui.renderFiles(); $('branchName').textContent = store.branch;
                } catch(e) { ui.toast(e.message, 'err'); } finally { ui.load(0); }
            },
            setBranch() { const b=$('branchInput').value.trim(); if(b) { store.branch=b; $('branchName').textContent=b; $('branchInputArea').classList.add('hidden'); this.fetch(); } },
            goDir(p) { store.path=p; this.fetch(); }, goHome() { store.path=''; this.fetch(); },
            async openFile(f) {
                ui.load(1); try {
                    const r = await fetch(f.url, { headers: { Authorization: `token ${store.token}` } });
                    const d = await r.json(); const c = decodeURIComponent(escape(window.atob(d.content.replace(/\n/g,""))));
                    store.currSha=d.sha; store.currPath=f.path; editor.open(f.name, c);
                } catch(e) { ui.toast('Open Error', 'err'); } finally { ui.load(0); }
            },
            async performAction() {
                const isFile = ui.tab==='file'; const msg = $('commitMsg').value.trim() || 'Update';
                let path, content;
                if(isFile) {
                    const f = $('fileInput').files[0]; if(!f) return ui.toast('No File', 'err');
                    path = store.path ? `${store.path}/${f.name}` : f.name;
                    content = await new Promise(r => { const rd = new FileReader(); rd.onload=()=>r(rd.result.split(',')[1]); rd.readAsDataURL(f); });
                } else {
                    const n = $('newFileName').value.trim(); const t = $('newFileContent').value;
                    if(!n) return ui.toast('No Name', 'err'); path = store.path ? `${store.path}/${n}` : n;
                    content = btoa(unescape(encodeURIComponent(t)));
                }
                let sha=null; try { const c=await fetch(`https://api.github.com/repos/${store.repo}/contents/${path}?ref=${store.branch}`,{headers:{Authorization:`token ${store.token}`}}); if(c.ok) sha=(await c.json()).sha; } catch(e){}
                ui.load(1); try {
                    const r = await fetch(`https://api.github.com/repos/${store.repo}/contents/${path}`, { method:'PUT', headers:{Authorization:`token ${store.token}`,'Content-Type':'application/json'}, body:JSON.stringify({message:msg, content:content, sha:sha, branch:store.branch}) });
                    if(!r.ok) throw new Error('Commit Failed');
                    ui.toggleUploadModal(false); ui.toast('Success', 'ok'); this.fetch();
                } catch(e) { ui.toast(e.message, 'err'); } finally { ui.load(0); }
            }
        };

        const editor = {
            open(n,c) { $('codeEditor').value=c; $('editorTitle').textContent=n; $('viewEditor').classList.remove('hidden'); },
            close() { $('viewEditor').classList.add('hidden'); },
            async save() {
                if(!confirm('Save?')) return; const c=$('codeEditor').value; const enc=btoa(unescape(encodeURIComponent(c)));
                ui.load(1); try {
                    const r = await fetch(`https://api.github.com/repos/${store.repo}/contents/${store.currPath}`, { method:'PUT', headers:{Authorization:`token ${store.token}`}, body:JSON.stringify({message:`Update ${store.currPath}`, content:enc, sha:store.currSha, branch:store.branch}) });
                    if(!r.ok) throw new Error('Save Failed');
                    store.currSha=(await r.json()).content.sha; ui.toast('Saved', 'ok'); this.close(); app.fetch();
                } catch(e) { ui.toast(e.message, 'err'); } finally { ui.load(0); }
            }
        };

        const ui = {
            tab: 'file',
            load(s) { $('loader').classList.toggle('hidden', !s); },
            renderFiles() {
                const l = $('fileList'); if(!store.files.length) { l.innerHTML = '<div class="p-8 text-center text-gray-400 text-xs">Empty</div>'; return; }
                $('fileCount').textContent = store.files.length + ' items';
                $('breadcrumbs').innerHTML = store.path ? store.path.split('/').map(p => `<span class="text-gray-300">/</span> ${p}`).join(' ') : 'root';
                store.files.sort((a,b)=>(a.type===b.type?0:a.type==='dir'?-1:1));
                l.innerHTML = store.files.map(f => {
                    const icon = f.type==='dir' ? '<i class="fas fa-folder text-[#54aeff] text-lg"></i>' : '<i class="far fa-file-code text-gray-400 text-lg"></i>';
                    return `<div onclick="${f.type==='dir'?`app.goDir('${f.path}')`:`app.openFile({url:'${f.url}',path:'${f.path}',name:'${f.name}'})`}" class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-[#1f242c] cursor-pointer border-b border-gray-50 dark:border-[#161b22]"><div class="w-8 flex justify-center">${icon}</div><div class="flex-1 text-sm dark:text-gray-200 truncate">${f.name}</div></div>`;
                }).join('');
            },
            renderEmpty() { $('fileList').innerHTML = `<div class="p-8 text-center"><p class="text-xs text-gray-500 mb-2">Empty Repo</p><button onclick="ui.toggleUploadModal(true)" class="text-blue-500 text-xs font-bold">+ Create File</button></div>`; },
            toggleUploadModal(show) {
                const m=$('uploadModal'), b=$('uploadBackdrop'), p=$('uploadPanel');
                if(show) {
                    m.classList.remove('hidden'); $('fileInput').value=''; $('fileNameDisplay').textContent=''; $('commitMsg').value='';
                    b.classList.remove('animate-fade-out'); b.classList.add('animate-fade-in');
                    p.classList.remove('animate-slide-down'); p.classList.add('animate-slide-up');
                } else {
                    b.classList.remove('animate-fade-in'); b.classList.add('animate-fade-out');
                    p.classList.remove('animate-slide-up'); p.classList.add('animate-slide-down');
                    setTimeout(()=>{ if(p.classList.contains('animate-slide-down')) m.classList.add('hidden'); }, 280);
                }
            },
            setTab(t) {
                this.tab=t; const bF=$('tabFile'), bN=$('tabNew'), pF=$('paneFile'), pN=$('paneNew');
                const on='flex-1 py-2 text-xs font-bold rounded bg-white dark:bg-[#21262d] text-gray-900 dark:text-white shadow-sm transition-all';
                const off='flex-1 py-2 text-xs font-medium rounded text-gray-500 dark:text-gray-400 transition-all';
                if(t==='file') { bF.className=on; bN.className=off; pF.classList.remove('hidden'); pN.classList.add('hidden'); }
                else { bN.className=on; bF.className=off; pN.classList.remove('hidden'); pF.classList.add('hidden'); }
            },
            toast(m,t) { const el=$('toast'); $('toastMsg').textContent=m; $('toastIcon').className=t==='err'?'fas fa-exclamation text-red-400':'fas fa-check text-green-400'; el.style.opacity=1; el.style.top='24px'; setTimeout(()=>{el.style.opacity=0; el.style.top='0px';},2000); }
        };

        window.onload = () => auth.init();
    </script>
</body>
</html>

