<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy GitHub Uploader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        github: {
                            dark: '#0d1117',
                            card: '#161b22',
                            border: '#30363d',
                            input: '#010409',
                            btn: '#238636',
                            btnHover: '#2ea043',
                            danger: '#da3633',
                            text: '#c9d1d9'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Segoe UI', 'Sarabun', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            background-image: radial-gradient(#20252e 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .glass-panel {
            background: rgba(22, 27, 34, 0.85);
            border: 1px solid #30363d;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        .input-dark {
            background-color: #010409;
            border: 1px solid #30363d;
            color: #c9d1d9;
            transition: all 0.2s;
        }
        .input-dark:focus {
            border-color: #58a6ff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- LOGIN VIEW -->
    <div id="loginView" class="w-full max-w-md glass-panel rounded-2xl p-8 text-center animate-fade-in">
        <div class="mb-6">
            <i class="fab fa-github text-6xl text-white mb-4"></i>
            <h1 class="text-2xl font-bold text-white">GitHub Connect</h1>
            <p class="text-gray-400 text-sm mt-2">เชื่อมต่อเพื่ออัปโหลดไฟล์แบบง่ายๆ</p>
        </div>

        <div class="space-y-4 text-left">
            <div>
                <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Personal Access Token</label>
                <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxx" class="input-dark w-full rounded-lg px-4 py-3 text-sm">
            </div>

            <button onclick="handleLogin()" id="loginBtn" class="w-full bg-[#238636] hover:bg-[#2ea043] text-white font-bold py-3 rounded-lg transition-all shadow-lg flex items-center justify-center gap-2">
                <span>เข้าสู่ระบบ</span>
                <i class="fas fa-arrow-right"></i>
            </button>

            <div class="relative py-2">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-700"></div></div>
                <div class="relative flex justify-center"><span class="bg-[#161b22] px-2 text-xs text-gray-500">ยังไม่มี Token?</span></div>
            </div>

            <a href="https://github.com/settings/tokens/new?scopes=repo&description=Simple%20GitHub%20Uploader" target="_blank" class="block w-full text-center py-2.5 rounded-lg border border-gray-600 text-gray-300 hover:bg-gray-800 hover:text-white transition-colors text-sm">
                <i class="fas fa-key mr-2"></i>สร้าง Token อัตโนมัติ (คลิกเลย)
            </a>
            <p class="text-[10px] text-gray-500 text-center">
                *คลิกปุ่มด้านบน -> เลื่อนลงล่างสุด -> กด Generate token -> ก๊อปปี้มาวาง
            </p>
        </div>
    </div>

    <!-- MAIN APP VIEW (Hidden by default) -->
    <div id="appView" class="hidden w-full max-w-2xl glass-panel rounded-2xl p-0 overflow-hidden animate-fade-in">
        
        <!-- Header / User Profile -->
        <div class="bg-[#21262d]/50 p-6 flex items-center justify-between border-b border-gray-700">
            <div class="flex items-center gap-4">
                <img id="userAvatar" src="" alt="Avatar" class="w-12 h-12 rounded-full border-2 border-gray-600 shadow-md">
                <div>
                    <h2 id="userName" class="text-lg font-bold text-white leading-tight">User</h2>
                    <p id="userLogin" class="text-sm text-gray-400">@username</p>
                </div>
            </div>
            <button onclick="handleLogout()" class="text-gray-400 hover:text-red-400 transition-colors text-sm px-3 py-1 rounded border border-transparent hover:border-gray-700">
                <i class="fas fa-sign-out-alt mr-1"></i> ออกจากระบบ
            </button>
        </div>

        <div class="p-6 space-y-6">
            
            <!-- Repo Selection -->
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Repository Name</label>
                    <div class="flex gap-2">
                        <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-700 bg-gray-800 text-gray-400 text-sm" id="repoOwnerPrefix">user/</span>
                        <input type="text" id="repoInput" placeholder="my-project" class="input-dark w-full rounded-r-lg rounded-l-none px-4 py-3 text-sm placeholder-gray-600">
                    </div>
                    <p class="text-[11px] text-gray-500 mt-1 ml-1">พิมพ์ชื่อ Repo ที่คุณมีอยู่แล้วใน GitHub</p>
                </div>
            </div>

            <!-- Upload Area -->
            <div class="border-2 border-dashed border-[#30363d] bg-[#0d1117]/50 rounded-xl p-8 text-center hover:border-blue-500/50 hover:bg-[#0d1117] transition-all cursor-pointer group" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(this)">
                <div id="dropZoneContent" class="space-y-3">
                    <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-cloud-upload-alt text-2xl text-blue-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-white">คลิกเพื่อเลือกไฟล์</h3>
                    <p class="text-sm text-gray-500">หรือลากไฟล์มาวางที่นี่</p>
                </div>
            </div>

            <!-- Commit Msg & Action -->
            <div class="space-y-4">
                <input type="text" id="commitMsg" placeholder="เขียนบันทึก (เช่น: อัปเดตโค้ดล่าสุด)" class="input-dark w-full rounded-lg px-4 py-2 text-sm">
                
                <button onclick="uploadFile()" id="uploadBtn" class="w-full bg-[#238636] hover:bg-[#2ea043] text-white font-bold py-3.5 rounded-lg transition-all shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 disabled:grayscale">
                    <i class="fas fa-paper-plane"></i>
                    <span>อัปโหลดขึ้น GitHub</span>
                </button>
            </div>

            <!-- Advanced Options Toggle -->
            <div class="pt-2">
                <button onclick="toggleAdvanced()" class="text-xs text-gray-500 hover:text-blue-400 flex items-center gap-1 mx-auto">
                    <i class="fas fa-cog"></i> ตั้งค่าเพิ่มเติม (Branch/Path) <i class="fas fa-chevron-down transition-transform" id="advIcon"></i>
                </button>
                <div id="advancedOptions" class="hidden mt-4 p-4 bg-[#161b22] rounded-lg border border-gray-700 grid grid-cols-2 gap-4 text-sm animate-fade-in">
                    <div>
                        <label class="block text-gray-400 mb-1">Branch</label>
                        <input type="text" id="branchInput" value="main" class="input-dark w-full rounded px-2 py-1">
                    </div>
                    <div>
                        <label class="block text-gray-400 mb-1">Path (Folder)</label>
                        <input type="text" id="pathInput" placeholder="src/assets/" class="input-dark w-full rounded px-2 py-1">
                    </div>
                </div>
            </div>

            <!-- Status Area -->
            <div id="statusArea" class="hidden rounded-lg p-3 text-sm flex items-start gap-3 animate-fade-in">
                <i id="statusIcon" class="fas fa-info-circle mt-0.5"></i>
                <div>
                    <strong id="statusTitle" class="block font-semibold">Message</strong>
                    <span id="statusDesc" class="opacity-90">Description</span>
                    <a id="statusLink" href="#" target="_blank" class="block mt-1 underline font-medium hover:text-white hidden">ดูไฟล์ที่นี่</a>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Global State ---
        let CURRENT_USER = null;
        let TOKEN = null;

        // --- Initialization ---
        window.addEventListener('load', async () => {
            const savedToken = localStorage.getItem('gh_token_easy');
            if (savedToken) {
                document.getElementById('tokenInput').value = savedToken;
                await handleLogin(true); // Auto login quietly
            }
            
            // Restore last repo
            const lastRepo = localStorage.getItem('gh_last_repo');
            if (lastRepo) document.getElementById('repoInput').value = lastRepo;
        });

        // --- Login Logic ---
        async function handleLogin(isAuto = false) {
            const tokenVal = document.getElementById('tokenInput').value.trim();
            const btn = document.getElementById('loginBtn');
            
            if (!tokenVal) {
                if(!isAuto) alert('กรุณาใส่ Token ก่อนครับ');
                return;
            }

            if(!isAuto) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังตรวจสอบ...';
                btn.disabled = true;
            }

            try {
                // Verify Token by fetching user profile
                const res = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `token ${tokenVal}` }
                });

                if (!res.ok) throw new Error('Token ไม่ถูกต้อง หรือหมดอายุ');

                const userData = await res.json();
                
                // Success: Setup App View
                CURRENT_USER = userData;
                TOKEN = tokenVal;
                
                // Save token
                localStorage.setItem('gh_token_easy', tokenVal);

                // Update UI
                document.getElementById('userAvatar').src = userData.avatar_url;
                document.getElementById('userName').textContent = userData.name || userData.login;
                document.getElementById('userLogin').textContent = `@${userData.login}`;
                document.getElementById('repoOwnerPrefix').textContent = `${userData.login}/`;

                // Switch Views
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('appView').classList.remove('hidden');
                document.getElementById('appView').classList.add('block');

            } catch (err) {
                if(!isAuto) alert('เกิดข้อผิดพลาด: ' + err.message);
                localStorage.removeItem('gh_token_easy'); // Clear bad token
            } finally {
                btn.innerHTML = '<span>เข้าสู่ระบบ</span><i class="fas fa-arrow-right"></i>';
                btn.disabled = false;
            }
        }

        function handleLogout() {
            if(confirm('ต้องการออกจากระบบ?')) {
                localStorage.removeItem('gh_token_easy');
                location.reload();
            }
        }

        // --- UI Interactions ---
        function toggleAdvanced() {
            const section = document.getElementById('advancedOptions');
            const icon = document.getElementById('advIcon');
            section.classList.toggle('hidden');
            icon.style.transform = section.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }

        function handleFileSelect(input) {
            const content = document.getElementById('dropZoneContent');
            const file = input.files[0];
            const msgInput = document.getElementById('commitMsg');

            if (file) {
                content.innerHTML = `
                    <div class="text-green-400 mb-2"><i class="fas fa-check-circle text-3xl"></i></div>
                    <h3 class="text-white font-medium truncate max-w-[200px] mx-auto">${file.name}</h3>
                    <p class="text-xs text-gray-500">${(file.size/1024).toFixed(1)} KB</p>
                    <p class="text-xs text-blue-400 mt-2 hover:underline">คลิกเพื่อเปลี่ยนไฟล์</p>
                `;
                // Auto fill commit message
                if (!msgInput.value) msgInput.value = `Add ${file.name}`;
            }
        }

        // --- Upload Logic ---
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const repoName = document.getElementById('repoInput').value.trim();
            const branch = document.getElementById('branchInput').value.trim() || 'main';
            const pathPrefix = document.getElementById('pathInput').value.trim();
            const message = document.getElementById('commitMsg').value.trim();
            const btn = document.getElementById('uploadBtn');

            if (!fileInput.files[0] || !repoName || !message) {
                alert('กรุณาเลือกไฟล์, ใส่ชื่อ Repo และเขียนข้อความ Commit');
                return;
            }

            // Save repo for next time
            localStorage.setItem('gh_last_repo', repoName);

            // Prepare UI
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> กำลังส่งข้อมูล...';
            hideStatus();

            try {
                const file = fileInput.files[0];
                const contentBase64 = await toBase64(file);
                
                // Construct Path
                let finalPath = file.name;
                if (pathPrefix) {
                    finalPath = `${pathPrefix.replace(/\/$/, '')}/${file.name}`.replace(/^\//, '');
                }

                const owner = CURRENT_USER.login;
                const url = `https://api.github.com/repos/${owner}/${repoName}/contents/${finalPath}`;

                // 1. Check existing file for SHA (Update mode)
                let sha = null;
                try {
                    const checkRes = await fetch(`${url}?ref=${branch}`, {
                        headers: { 'Authorization': `token ${TOKEN}` }
                    });
                    if (checkRes.ok) {
                        const data = await checkRes.json();
                        sha = data.sha;
                    }
                } catch (e) { /* Ignore error, assume new file */ }

                // 2. Upload
                const body = {
                    message: message,
                    content: contentBase64,
                    branch: branch
                };
                if (sha) body.sha = sha;

                const res = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const result = await res.json();

                if (!res.ok) throw new Error(result.message);

                showStatus('success', 'อัปโหลดเรียบร้อย!', `ไฟล์ ${finalPath} ถูกส่งขึ้น GitHub แล้ว`, result.content.html_url);
                
                // Reset file input slightly
                document.getElementById('commitMsg').value = '';
                
            } catch (err) {
                showStatus('error', 'เกิดข้อผิดพลาด', err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> อัปโหลดขึ้น GitHub';
            }
        }

        // --- Helpers ---
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function showStatus(type, title, desc, url = null) {
            const area = document.getElementById('statusArea');
            const icon = document.getElementById('statusIcon');
            const link = document.getElementById('statusLink');
            
            area.classList.remove('hidden', 'bg-green-900/30', 'border-green-800', 'text-green-400', 'bg-red-900/30', 'border-red-800', 'text-red-400');
            
            if (type === 'success') {
                area.classList.add('bg-green-900/20', 'border', 'border-green-800', 'text-green-400');
                icon.className = 'fas fa-check-circle text-lg mt-0.5';
            } else {
                area.classList.add('bg-red-900/20', 'border', 'border-red-800', 'text-red-400');
                icon.className = 'fas fa-times-circle text-lg mt-0.5';
            }

            document.getElementById('statusTitle').textContent = title;
            document.getElementById('statusDesc').textContent = desc;

            if (url) {
                link.href = url;
                link.classList.remove('hidden');
            } else {
                link.classList.add('hidden');
            }
        }

        function hideStatus() {
            document.getElementById('statusArea').classList.add('hidden');
        }
    </script>
</body>
</html>
