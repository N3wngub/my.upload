import React, { useState, useEffect } from 'react';
import { 
  Github, Key, LogOut, Folder, FileCode, ArrowLeft, 
  Save, Upload, Plus, X, Check, Loader2, 
  Search, FileText, Image as ImageIcon, Home, 
  Globe, Sparkles, Bot, FilePlus, Trash2, AlertTriangle
} from 'lucide-react';

// --- Configuration & Constants ---
const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
const apiKey = ""; // System injects this at runtime

// --- Translations ---
const t = {
  th: {
    app_name: "GitHub Manager",
    slogan: "จัดการโค้ดได้ทุกที่ ด้วยพลัง AI",
    pat_label: "Personal Access Token",
    login_btn: "เข้าสู่ระบบ",
    login_guide: "สร้าง Token",
    repos_title: "คลังข้อมูล",
    search_placeholder: "ค้นหา...",
    files_title: "ไฟล์",
    empty_folder: "โฟลเดอร์ว่างเปล่า",
    upload_file: "อัปโหลดไฟล์",
    create_file: "สร้างไฟล์ใหม่",
    cancel: "ยกเลิก",
    save: "บันทึก",
    edit: "แก้ไข",
    delete: "ลบ",
    delete_confirm_title: "ยืนยันการลบไฟล์",
    delete_confirm_msg: "คุณแน่ใจหรือไม่ว่าต้องการลบไฟล์",
    ai_magic: "ให้ AI ช่วยเขียน",
    ai_placeholder: "บอกสิ่งที่ต้องการ (เช่น: สร้างฟอร์ม login html สวยๆ)",
    ai_generating: "AI กำลังคิด...",
    ai_btn: "สร้างเนื้อหา",
    logout: "ออกจากระบบ",
    file_name: "ชื่อไฟล์ (เช่น index.html)",
    success_save: "บันทึกเรียบร้อย",
    success_upload: "อัปโหลดสำเร็จ",
    success_delete: "ลบไฟล์สำเร็จ",
    error_token: "Token ไม่ถูกต้อง",
    error_fetch: "โหลดข้อมูลไม่สำเร็จ",
    error_delete: "ลบไฟล์ไม่สำเร็จ",
    error_ai: "AI ทำงานผิดพลาด โปรดลองใหม่",
    warning_cannot_undo: "การกระทำนี้ไม่สามารถย้อนกลับได้"
  },
  en: {
    app_name: "GitHub Manager",
    slogan: "Manage code anywhere with AI power",
    pat_label: "Personal Access Token",
    login_btn: "Login",
    login_guide: "Generate Token",
    repos_title: "Repositories",
    search_placeholder: "Search...",
    files_title: "Files",
    empty_folder: "Empty Folder",
    upload_file: "Upload File",
    create_file: "Create New File",
    cancel: "Cancel",
    save: "Save",
    edit: "Edit",
    delete: "Delete",
    delete_confirm_title: "Confirm Deletion",
    delete_confirm_msg: "Are you sure you want to delete",
    ai_magic: "Ask AI to Write",
    ai_placeholder: "Describe what you need (e.g., Create a beautiful login form)",
    ai_generating: "AI is thinking...",
    ai_btn: "Generate",
    logout: "Logout",
    file_name: "File Name (e.g. index.html)",
    success_save: "Saved successfully",
    success_upload: "Upload success",
    success_delete: "Deleted successfully",
    error_token: "Invalid Token",
    error_fetch: "Failed to fetch data",
    error_delete: "Failed to delete file",
    error_ai: "AI failed, please try again",
    warning_cannot_undo: "This action cannot be undone."
  }
};

// --- Utility Functions ---
const utf8_to_b64 = (str) => window.btoa(unescape(encodeURIComponent(str)));
const b64_to_utf8 = (str) => decodeURIComponent(escape(window.atob(str)));

export default function App() {
  // --- State ---
  const [lang, setLang] = useState('th');
  const txt = t[lang];

  const [token, setToken] = useState('');
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [user, setUser] = useState(null);
  
  const [repos, setRepos] = useState([]);
  const [filteredRepos, setFilteredRepos] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  
  // Navigation & Data
  const [currentView, setCurrentView] = useState('login'); 
  const [direction, setDirection] = useState('forward');
  const [currentRepo, setCurrentRepo] = useState(null);
  const [currentPath, setCurrentPath] = useState([]);
  const [files, setFiles] = useState([]);
  
  // Editor
  const [currentFile, setCurrentFile] = useState(null); 
  const [editorContent, setEditorContent] = useState('');
  const [isEditing, setIsEditing] = useState(false);
  const [newFileName, setNewFileName] = useState('');
  
  // UI & Loading
  const [isLoading, setIsLoading] = useState(false);
  const [showActionModal, setShowActionModal] = useState(false);
  const [showAiModal, setShowAiModal] = useState(false);
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [aiPrompt, setAiPrompt] = useState('');
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [toast, setToast] = useState(null);

  // --- Effects ---
  useEffect(() => {
    const savedToken = localStorage.getItem('github_pat');
    if (savedToken) {
      setToken(savedToken);
      verifyToken(savedToken);
    }
  }, []);

  useEffect(() => {
    if (searchQuery) {
      setFilteredRepos(repos.filter(r => r.name.toLowerCase().includes(searchQuery.toLowerCase())));
    } else {
      setFilteredRepos(repos);
    }
  }, [searchQuery, repos]);

  useEffect(() => {
    if (toast) {
      const timer = setTimeout(() => setToast(null), 3000);
      return () => clearTimeout(timer);
    }
  }, [toast]);

  // --- Navigation Helper ---
  const navigateTo = (view, dir = 'forward') => {
    setDirection(dir);
    setCurrentView(view);
  };

  // --- API Actions ---
  const showToast = (message, type = 'success') => setToast({ message, type });

  const verifyToken = async (inputToken) => {
    setIsLoading(true);
    try {
      const res = await fetch('https://api.github.com/user', {
        headers: { Authorization: `token ${inputToken}` }
      });
      if (res.ok) {
        const userData = await res.json();
        setUser(userData);
        setIsAuthenticated(true);
        localStorage.setItem('github_pat', inputToken);
        fetchRepos(inputToken);
        navigateTo('repos');
      } else {
        throw new Error(txt.error_token);
      }
    } catch (error) {
      showToast(txt.error_token, 'error');
      localStorage.removeItem('github_pat');
    } finally {
      setIsLoading(false);
    }
  };

  const fetchRepos = async (authToken) => {
    setIsLoading(true);
    try {
      const res = await fetch('https://api.github.com/user/repos?sort=updated&per_page=50', {
        headers: { Authorization: `token ${authToken}` }
      });
      const data = await res.json();
      setRepos(data);
      setFilteredRepos(data);
    } catch (error) {
      showToast(txt.error_fetch, 'error');
    } finally {
      setIsLoading(false);
    }
  };

  const fetchFiles = async (repo, pathArray = []) => {
    setIsLoading(true);
    const pathString = pathArray.join('/');
    try {
      const res = await fetch(`https://api.github.com/repos/${repo.full_name}/contents/${pathString}`, {
        headers: { Authorization: `token ${token}` }
      });
      const data = await res.json();
      const sortedData = Array.isArray(data) ? data.sort((a, b) => {
        if (a.type === b.type) return a.name.localeCompare(b.name);
        return a.type === 'dir' ? -1 : 1;
      }) : [];

      setFiles(sortedData);
      setCurrentRepo(repo);
      setCurrentPath(pathArray);
      navigateTo('files', pathArray.length < currentPath.length ? 'back' : 'forward');
    } catch (error) {
      showToast(txt.error_fetch, 'error');
    } finally {
      setIsLoading(false);
    }
  };

  const openFile = async (file) => {
    setIsLoading(true);
    try {
      const res = await fetch(file.url, { headers: { Authorization: `token ${token}` } });
      const data = await res.json();
      let content = '';
      if (data.encoding === 'base64') {
        try { content = b64_to_utf8(data.content.replace(/\n/g, '')); } 
        catch (e) { content = "Binary file (cannot display)"; }
      }
      setCurrentFile({ ...file, sha: data.sha, content: content });
      setEditorContent(content);
      setIsEditing(false);
      setNewFileName('');
      navigateTo('editor', 'forward');
    } catch (error) {
      showToast(txt.error_fetch, 'error');
    } finally {
      setIsLoading(false);
    }
  };

  const createNewFile = () => {
    setCurrentFile(null);
    setEditorContent('');
    setIsEditing(true);
    setNewFileName('');
    setShowActionModal(false);
    navigateTo('editor', 'forward');
  };

  const saveFile = async () => {
    if (!currentRepo) return;
    let targetPath = currentFile ? currentFile.path : [...currentPath, newFileName].join('/');
    if (!currentFile && !newFileName) {
      showToast("Please enter a file name", "error");
      return;
    }

    setIsLoading(true);
    try {
      const body = {
        message: `Update ${targetPath} via Mobile App`,
        content: utf8_to_b64(editorContent),
      };
      if (currentFile && currentFile.sha) body.sha = currentFile.sha;

      const res = await fetch(`https://api.github.com/repos/${currentRepo.full_name}/contents/${targetPath}`, {
        method: 'PUT',
        headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (res.ok) {
        const data = await res.json();
        setCurrentFile({ 
            name: data.content.name, 
            path: data.content.path, 
            sha: data.content.sha, 
            content: editorContent 
        });
        showToast(txt.success_save);
        setIsEditing(false);
      } else {
        throw new Error('Save failed');
      }
    } catch (error) {
      showToast(txt.error_fetch, 'error');
    } finally {
      setIsLoading(false);
    }
  };

  const deleteFile = async () => {
    if (!currentFile || !currentRepo) return;
    setIsLoading(true);
    try {
      const res = await fetch(`https://api.github.com/repos/${currentRepo.full_name}/contents/${currentFile.path}`, {
        method: 'DELETE',
        headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: `Delete ${currentFile.name} via Mobile App`,
          sha: currentFile.sha
        })
      });

      if (res.ok) {
        showToast(txt.success_delete);
        setShowDeleteModal(false);
        navigateTo('files', 'back');
        fetchFiles(currentRepo, currentPath); // Refresh list
      } else {
        throw new Error('Delete failed');
      }
    } catch (error) {
      showToast(txt.error_delete, 'error');
    } finally {
      setIsLoading(false);
    }
  };

  const generateWithAI = async () => {
    if (!aiPrompt) return;
    setIsAiLoading(true);
    try {
      const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `Generate code/text for a file based on this request: "${aiPrompt}". Only provide the code/text content, no markdown backticks, no explanations.` }] }]
        })
      });
      
      const result = await response.json();
      const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
      
      setEditorContent(generatedText);
      setShowAiModal(false);
      showToast("AI Generated Content!", "success");
    } catch (e) {
      showToast(txt.error_ai, 'error');
    } finally {
      setIsAiLoading(false);
    }
  };

  const handleFileUpload = async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
      const contentBase64 = e.target.result.split(',')[1];
      setIsLoading(true);
      setShowActionModal(false);
      try {
        const pathString = [...currentPath, file.name].join('/');
        let sha = null;
        try {
           const checkRes = await fetch(`https://api.github.com/repos/${currentRepo.full_name}/contents/${pathString}`, {
             headers: { Authorization: `token ${token}` }
           });
           if (checkRes.ok) sha = (await checkRes.json()).sha;
        } catch (e) {}

        const body = { message: `Upload ${file.name}`, content: contentBase64 };
        if (sha) body.sha = sha;

        const res = await fetch(`https://api.github.com/repos/${currentRepo.full_name}/contents/${pathString}`, {
          method: 'PUT',
          headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (res.ok) {
          showToast(txt.success_upload);
          fetchFiles(currentRepo, currentPath);
        }
      } catch (error) {
        showToast(txt.error_fetch, 'error');
      } finally {
        setIsLoading(false);
      }
    };
    reader.readAsDataURL(file);
  };

  // --- Render Helpers ---
  const LoadingOverlay = () => (
    <div className="fixed inset-0 bg-black/40 z-[60] flex items-center justify-center backdrop-blur-sm app-fade-in">
      <div className="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600 mb-3" />
        <p className="text-gray-600 font-medium text-sm">Loading...</p>
      </div>
    </div>
  );

  const PageContainer = ({ children, className = "" }) => (
    <div className={`min-h-screen bg-slate-50 w-full absolute top-0 left-0 transition-all duration-300 ease-out ${
      direction === 'forward' ? 'app-slide-in-right' : 'app-slide-in-left'
    } ${className}`}>
      {children}
    </div>
  );

  // --- Views ---

  // 1. Login View
  if (!isAuthenticated) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-blue-50 flex flex-col items-center justify-center p-6 relative overflow-hidden app-font">
        <style>{styles}</style>
        {isLoading && <LoadingOverlay />}
        {toast && <div className="fixed top-4 left-4 right-4 z-50 p-4 bg-red-100 text-red-700 rounded-xl shadow-lg border border-red-200 flex items-center gap-2 app-bounce-in"><X size={18}/>{toast.message}</div>}
        
        <button onClick={() => setLang(lang === 'th' ? 'en' : 'th')} className="absolute top-6 right-6 p-2 bg-white/50 backdrop-blur rounded-full shadow-sm text-indigo-600">
          <Globe size={20} />
        </button>

        <div className="w-full max-w-sm bg-white/80 backdrop-blur-xl p-8 rounded-[2rem] shadow-2xl border border-white/50 relative z-10 app-fade-in-up">
          <div className="flex justify-center mb-6">
            <div className="w-20 h-20 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-200 transform -rotate-3">
              <Github className="text-white w-12 h-12" />
            </div>
          </div>
          <h1 className="text-3xl font-bold text-center text-slate-800 mb-2">{txt.app_name}</h1>
          <p className="text-center text-slate-500 mb-8 text-sm">{txt.slogan}</p>

          <div className="space-y-4">
            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1 tracking-wider">{txt.pat_label}</label>
              <div className="relative group">
                <Key className="absolute left-4 top-3.5 text-slate-400 w-5 h-5 group-focus-within:text-indigo-500 transition-colors" />
                <input
                  type="password"
                  value={token}
                  onChange={(e) => setToken(e.target.value)}
                  className="w-full pl-12 pr-4 py-3.5 bg-slate-50 border-2 border-transparent focus:border-indigo-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition-all font-mono text-sm"
                  placeholder="ghp_..."
                />
              </div>
            </div>
            
            <button
              onClick={() => verifyToken(token)}
              disabled={!token}
              className="w-full bg-slate-900 hover:bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg shadow-slate-200 active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              {txt.login_btn}
            </button>
          </div>
          <div className="mt-6 text-center">
            <a href="https://github.com/settings/tokens" target="_blank" rel="noreferrer" className="text-xs text-indigo-600 hover:text-indigo-800 font-medium">
              {txt.login_guide}
            </a>
          </div>
        </div>
      </div>
    );
  }

  // 2. Repositories View
  if (currentView === 'repos') {
    return (
      <PageContainer className="app-font">
        <style>{styles}</style>
        {isLoading && <LoadingOverlay />}
        {toast && <div className="fixed top-4 inset-x-4 z-50 p-3 bg-slate-800 text-white rounded-lg shadow-xl text-center text-sm app-fade-in-down">{toast.message}</div>}

        <header className="bg-white/80 backdrop-blur-md px-6 pt-12 pb-4 sticky top-0 z-20 border-b border-slate-100">
          <div className="flex justify-between items-center mb-6">
            <div className="flex items-center gap-3">
              <img src={user.avatar_url} alt="Profile" className="w-10 h-10 rounded-full border border-slate-200" />
              <div>
                <h2 className="font-bold text-slate-800 text-lg leading-none">{user.login}</h2>
                <p className="text-xs text-slate-400 mt-1">{txt.repos_title}</p>
              </div>
            </div>
            <div className="flex gap-2">
              <button onClick={() => setLang(lang === 'th' ? 'en' : 'th')} className="p-2 bg-slate-100 rounded-full text-slate-600 hover:bg-slate-200">
                <Globe size={20} />
              </button>
              <button onClick={() => { setToken(''); setIsAuthenticated(false); localStorage.removeItem('github_pat'); }} className="p-2 bg-slate-100 rounded-full text-slate-600 hover:bg-red-50 hover:text-red-500">
                <LogOut size={20} />
              </button>
            </div>
          </div>
          <div className="relative">
            <Search className="absolute left-4 top-3.5 text-slate-400 w-5 h-5" />
            <input 
              type="text" 
              placeholder={txt.search_placeholder} 
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full pl-12 pr-4 py-3 bg-slate-100 border-none rounded-2xl text-slate-800 focus:ring-2 focus:ring-indigo-500 transition-all placeholder:text-slate-400"
            />
          </div>
        </header>

        <div className="px-4 py-6 space-y-3 pb-20">
          {filteredRepos.map((repo, i) => (
            <div 
              key={repo.id}
              onClick={() => fetchFiles(repo)}
              className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-[0.98] transition-all cursor-pointer flex items-center justify-between group hover:shadow-md app-fade-in-up"
              style={{ animationDelay: `${i * 0.05}s` }}
            >
              <div className="flex items-center gap-4 min-w-0">
                <div className={`w-12 h-12 rounded-xl flex items-center justify-center shrink-0 ${repo.private ? 'bg-amber-50 text-amber-500' : 'bg-blue-50 text-blue-500'}`}>
                  {repo.private ? <Key size={20} /> : <Folder size={20} />}
                </div>
                <div className="min-w-0">
                  <h3 className="font-semibold text-slate-800 truncate text-base">{repo.name}</h3>
                  <p className="text-xs text-slate-400 truncate mt-0.5">{repo.description || 'No description'}</p>
                </div>
              </div>
            </div>
          ))}
        </div>
      </PageContainer>
    );
  }

  // 3. File Browser View
  if (currentView === 'files') {
    return (
      <PageContainer className="app-font">
        <style>{styles}</style>
        {isLoading && <LoadingOverlay />}
        {toast && <div className="fixed top-4 inset-x-4 z-50 p-3 bg-slate-800 text-white rounded-lg shadow-xl text-center text-sm">{toast.message}</div>}

        <header className="bg-white/90 backdrop-blur shadow-sm sticky top-0 z-20 border-b border-slate-100 pt-10 pb-4 px-4">
          <div className="flex items-center gap-3">
            <button 
              onClick={() => {
                if (currentPath.length === 0) navigateTo('repos', 'back');
                else {
                  const newPath = [...currentPath];
                  newPath.pop();
                  fetchFiles(currentRepo, newPath);
                }
              }}
              className="p-2 -ml-2 rounded-full hover:bg-slate-100 text-slate-600"
            >
              <ArrowLeft size={24} />
            </button>
            <div className="flex-1 min-w-0">
               <h2 className="font-bold text-slate-900 truncate text-lg">{currentRepo.name}</h2>
               <div className="flex items-center text-xs text-slate-500 overflow-x-auto whitespace-nowrap no-scrollbar opacity-70">
                 <span className="flex items-center"><Home size={10} className="mr-1"/> root</span>
                 {currentPath.map((p, i) => (
                   <span key={i} className="flex items-center">
                     <span className="mx-1">/</span>
                     {p}
                   </span>
                 ))}
               </div>
            </div>
          </div>
        </header>

        <div className="p-4 grid gap-3 pb-24">
          {files.map((file, i) => (
            <div 
              key={file.sha}
              onClick={() => file.type === 'dir' ? fetchFiles(currentRepo, [...currentPath, file.name]) : openFile(file)}
              className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between active:bg-slate-50 cursor-pointer app-fade-in-up"
              style={{ animationDelay: `${i * 0.03}s` }}
            >
              <div className="flex items-center gap-3 min-w-0">
                {file.type === 'dir' ? (
                  <Folder className="text-blue-500 fill-blue-50" size={24} />
                ) : file.name.match(/\.(jpg|png|svg)$/i) ? (
                  <ImageIcon className="text-pink-500" size={24} />
                ) : (
                  <FileCode className="text-slate-500" size={24} />
                )}
                <span className="text-sm font-medium text-slate-700 truncate">{file.name}</span>
              </div>
            </div>
          ))}
          
          {files.length === 0 && (
            <div className="text-center py-20 text-slate-300 flex flex-col items-center">
              <Folder size={64} className="mb-4 stroke-1" />
              <p>{txt.empty_folder}</p>
            </div>
          )}
        </div>

        {/* FAB */}
        <button 
          onClick={() => setShowActionModal(true)}
          className="fixed bottom-8 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-lg shadow-indigo-300 flex items-center justify-center active:scale-90 transition-all z-30 hover:bg-indigo-700"
        >
          <Plus size={28} />
        </button>

        {/* Action Modal */}
        {showActionModal && (
          <div className="fixed inset-0 z-50 flex items-end justify-center">
            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={() => setShowActionModal(false)}></div>
            <div className="bg-white w-full max-w-md rounded-t-[2rem] p-6 relative z-10 app-slide-up-modal shadow-2xl">
              <div className="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>
              
              <div className="grid grid-cols-2 gap-4 mb-4">
                <button onClick={createNewFile} className="flex flex-col items-center gap-3 p-6 bg-indigo-50 rounded-2xl active:scale-95 transition-transform">
                    <div className="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center">
                        <FilePlus size={24} />
                    </div>
                    <span className="font-semibold text-indigo-900 text-sm">{txt.create_file}</span>
                </button>
                <label className="flex flex-col items-center gap-3 p-6 bg-emerald-50 rounded-2xl active:scale-95 transition-transform cursor-pointer">
                    <div className="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center">
                        <Upload size={24} />
                    </div>
                    <span className="font-semibold text-emerald-900 text-sm">{txt.upload_file}</span>
                    <input type="file" className="hidden" onChange={handleFileUpload} />
                </label>
              </div>

              <button 
                onClick={() => setShowActionModal(false)}
                className="w-full py-4 bg-slate-100 text-slate-700 rounded-xl font-bold mt-2"
              >
                {txt.cancel}
              </button>
            </div>
          </div>
        )}
      </PageContainer>
    );
  }

  // 4. Editor View
  if (currentView === 'editor') {
    return (
      <div className="h-screen flex flex-col bg-white app-fade-in app-font">
        <style>{styles}</style>
        {isLoading && <LoadingOverlay />}
        {toast && <div className="fixed top-4 inset-x-4 z-50 p-3 bg-slate-800 text-white rounded-lg shadow-xl text-center text-sm">{toast.message}</div>}

        {/* Editor Header */}
        <header className="bg-white border-b border-slate-100 pt-10 pb-3 px-4 flex items-center justify-between shrink-0 shadow-sm z-20">
          <div className="flex items-center gap-2 overflow-hidden flex-1">
            <button 
              onClick={() => navigateTo('files', 'back')}
              className="p-2 -ml-2 rounded-full hover:bg-slate-100 text-slate-600 shrink-0"
            >
              <ArrowLeft size={22} />
            </button>
            <div className="truncate flex flex-col mr-2">
              {currentFile ? (
                 <h2 className="font-bold text-sm text-slate-900 truncate">{currentFile.name}</h2>
              ) : (
                 <input 
                    type="text" 
                    value={newFileName}
                    onChange={(e) => setNewFileName(e.target.value)}
                    placeholder={txt.file_name}
                    className="font-bold text-sm text-slate-900 placeholder:text-slate-400 bg-transparent outline-none border-b border-transparent focus:border-indigo-500 w-full"
                 />
              )}
            </div>
          </div>
          
          <div className="flex gap-1.5 shrink-0">
             {/* Delete Button (Only for existing files) */}
             {currentFile && currentFile.sha && (
                <button 
                    onClick={() => setShowDeleteModal(true)}
                    className="p-2 text-red-500 hover:bg-red-50 rounded-lg active:scale-95 transition-all"
                    title={txt.delete}
                >
                    <Trash2 size={20} />
                </button>
             )}

             {/* AI Button */}
             {isEditing && (
                <button 
                    onClick={() => setShowAiModal(true)}
                    className="p-2 bg-gradient-to-tr from-purple-500 to-indigo-500 text-white rounded-lg shadow-md active:scale-95 transition-all"
                >
                    <Sparkles size={18} />
                </button>
             )}

            {isEditing ? (
              <button 
                onClick={saveFile}
                className="px-3 py-2 bg-slate-900 text-white text-sm rounded-lg font-bold flex items-center gap-1.5 shadow-lg active:scale-95 transition-all"
              >
                <Save size={16} /> {txt.save}
              </button>
            ) : (
              <button 
                onClick={() => setIsEditing(true)}
                className="px-3 py-2 bg-indigo-50 text-indigo-600 text-sm rounded-lg font-bold active:bg-indigo-100 transition-colors"
              >
                {txt.edit}
              </button>
            )}
          </div>
        </header>

        {/* Editor Area */}
        <div className="flex-1 relative overflow-hidden bg-slate-50">
          <textarea
            value={editorContent}
            onChange={(e) => setEditorContent(e.target.value)}
            disabled={!isEditing}
            className={`w-full h-full p-4 font-mono text-sm leading-relaxed outline-none resize-none transition-colors ${
              isEditing ? 'bg-white text-slate-800' : 'bg-slate-50 text-slate-600'
            }`}
            spellCheck="false"
            autoCapitalize="off"
            placeholder={isEditing ? "Start typing or use AI..." : "Empty file"}
          />
        </div>

        {/* Delete Confirmation Modal */}
        {showDeleteModal && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setShowDeleteModal(false)}></div>
            <div className="bg-white w-full max-w-sm rounded-3xl p-6 relative z-10 app-bounce-in shadow-2xl text-center">
              <div className="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <AlertTriangle size={32} />
              </div>
              <h3 className="font-bold text-xl text-slate-900 mb-2">{txt.delete_confirm_title}</h3>
              <p className="text-slate-500 text-sm mb-6">
                {txt.delete_confirm_msg} <br/>
                <span className="font-bold text-slate-800">"{currentFile?.name}"</span> ? <br/>
                <span className="text-red-500 text-xs mt-1 block">{txt.warning_cannot_undo}</span>
              </p>
              
              <div className="grid grid-cols-2 gap-3">
                <button 
                  onClick={() => setShowDeleteModal(false)}
                  className="py-3 bg-slate-100 text-slate-700 rounded-xl font-bold active:scale-95 transition-all"
                >
                  {txt.cancel}
                </button>
                <button 
                  onClick={deleteFile}
                  className="py-3 bg-red-600 text-white rounded-xl font-bold active:scale-95 transition-all shadow-lg shadow-red-200"
                >
                  {txt.delete}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* AI Modal */}
        {showAiModal && (
            <div className="fixed inset-0 z-50 flex items-end justify-center">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setShowAiModal(false)}></div>
                <div className="bg-white w-full rounded-t-[2rem] p-6 relative z-10 app-slide-up-modal">
                    <div className="flex items-center gap-2 mb-4 text-indigo-600">
                        <Bot size={24} />
                        <h3 className="font-bold text-lg">{txt.ai_magic}</h3>
                    </div>
                    
                    <textarea 
                        value={aiPrompt}
                        onChange={(e) => setAiPrompt(e.target.value)}
                        placeholder={txt.ai_placeholder}
                        className="w-full h-32 p-4 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none text-sm mb-4 resize-none"
                    />

                    <button 
                        onClick={generateWithAI}
                        disabled={isAiLoading || !aiPrompt}
                        className="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 disabled:opacity-50"
                    >
                        {isAiLoading ? <Loader2 className="animate-spin"/> : <Sparkles size={18} />}
                        {isAiLoading ? txt.ai_generating : txt.ai_btn}
                    </button>
                </div>
            </div>
        )}
      </div>
    );
  }

  return null;
}

// --- Inline Styles & Keyframes ---
const styles = `
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap');

  .app-font {
    font-family: 'Inter', 'Noto Sans Thai', sans-serif;
  }

  /* Scrollbar Hide */
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

  /* Animations Keyframes */
  @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  @keyframes slideInLeft { from { transform: translateX(-30%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  @keyframes slideUpModal { from { transform: translateY(100%); } to { transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes bounceIn { 
    0% { transform: scale(0.9); opacity: 0; } 
    50% { transform: scale(1.05); opacity: 1; } 
    100% { transform: scale(1); } 
  }

  /* Utility Classes for Animation */
  .app-slide-in-right { animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  .app-slide-in-left { animation: slideInLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  .app-slide-up-modal { animation: slideUpModal 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  .app-fade-in { animation: fadeIn 0.3s ease-out forwards; }
  .app-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
  .app-fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
  .app-bounce-in { animation: bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
`;

